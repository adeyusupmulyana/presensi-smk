<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Presensi Digital - SMK Handayani</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* CSS sama seperti sebelumnya */
        :root { --bg-primary: #0a0f1a; --bg-secondary: #111827; --bg-card: #1a2332; --fg-primary: #f1f5f9; --fg-secondary: #94a3b8; --fg-muted: #64748b; --accent: #f97316; --accent-glow: rgba(249, 115, 22, 0.3); --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --alpha: #6b7280; --border: #2d3a4f; }
        [data-theme="light"] { --bg-primary: #f8fafc; --bg-secondary: #ffffff; --bg-card: #ffffff; --fg-primary: #0f172a; --fg-secondary: #475569; --fg-muted: #94a3b8; --border: #e2e8f0; --accent-glow: rgba(249, 115, 22, 0.2); }
        * { box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-primary); color: var(--fg-primary); min-height: 100vh; overflow-x: hidden; transition: background 0.5s ease, color 0.5s ease; }
        .bg-mesh { position: fixed; inset: 0; background: radial-gradient(ellipse 80% 50% at 50% -20%, rgba(249, 115, 22, 0.12), transparent); pointer-events: none; z-index: 0; }
        .view { display: none; opacity: 0; transform: scale(0.98); transition: opacity 0.4s ease, transform 0.4s ease; }
        .view.active { display: block; animation: viewIn 0.5s ease forwards; }
        .step { display: none; opacity: 0; position: relative; }
        .step.active { display: block; animation: stepSlideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes stepSlideIn { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
        .card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; backdrop-filter: blur(10px); }
        .btn-primary, .btn-secondary, .btn-danger { position: relative; overflow: hidden; font-weight: 600; padding: 12px 24px; border-radius: 10px; border: none; cursor: pointer; transition: all 0.3s ease; font-family: inherit; font-size: 14px; display: inline-flex; align-items: center; justify-content: center; }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #ea580c); color: white; box-shadow: 0 4px 20px var(--accent-glow); }
        .btn-primary:disabled { opacity: 0.6; transform: none; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-secondary); color: var(--fg-primary); border: 1px solid var(--border); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid transparent; }
        .input-field { width: 100%; background: var(--bg-secondary); border: 2px solid var(--border); border-radius: 12px; padding: 12px 16px; color: var(--fg-primary); font-size: 14px; transition: all 0.3s ease; font-family: inherit; }
        .input-field:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }
        .hidden { display: none !important; }
        .sidebar { width: 260px; background: var(--bg-card); border-right: 1px solid var(--border); height: 100vh; position: fixed; left: 0; top: 0; z-index: 50; transition: transform 0.3s ease, background 0.5s; overflow-y: auto; }
        .sidebar-item { display: flex; align-items: center; gap: 12px; padding: 14px 20px; color: var(--fg-secondary); cursor: pointer; transition: all 0.2s ease; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: rgba(249, 115, 22, 0.1); color: var(--fg-primary); }
        .sidebar-item.active { background: rgba(249, 115, 22, 0.15); color: var(--accent); border-left-color: var(--accent); }
        .main-content { margin-left: 260px; min-height: 100vh; padding: 24px; transition: margin-left 0.3s ease; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 14px 16px; background: var(--bg-secondary); color: var(--fg-secondary); font-weight: 600; font-size: 12px; border-bottom: 1px solid var(--border); }
        .data-table td { padding: 14px 16px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-block; }
        .badge-success { background: rgba(16, 185, 129, 0.2); color: #10b981; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 500px; padding: 24px; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 200; }
        .toast { background: var(--bg-card); border: 1px solid var(--border); padding: 16px 20px; border-radius: 12px; margin-bottom: 10px; animation: toastIn 0.3s; }
        @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @media (max-width: 1024px) { .sidebar { transform: translateX(-100%); } .sidebar.open { transform: translateX(0); } .main-content { margin-left: 0; } }
    </style>
</head>
<body>
    <div class="bg-mesh"></div>
    <div class="toast-container" id="toastContainer"></div>

    <!-- LOGIN VIEW -->
    <div class="view active" id="loginView">
        <main class="min-h-screen flex items-center justify-center p-4 relative z-10">
            <div class="w-full max-w-md">
                <div class="card p-8">
                    <div class="text-center mb-8">
                        <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl mb-4" style="background: linear-gradient(135deg, var(--accent), #ea580c)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
                        </div>
                        <h1 class="font-display text-2xl font-bold mb-2">SMK Handayani Banjaran</h1>
                        <p style="color: var(--fg-secondary)">Sistem Presensi Digital</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--fg-secondary)">Mode Akses</label>
                            <select class="input-field" id="loginMode">
                                <option value="siswa">Siswa - Isi Presensi</option>
                                <option value="admin">Admin - Kelola Data</option>
                            </select>
                        </div>
                        <div id="adminLoginFields" class="space-y-4 hidden">
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--fg-secondary)">Username</label>
                                <input type="text" class="input-field" id="adminUsername" placeholder="Masukkan username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2" style="color: var(--fg-secondary)">Password</label>
                                <input type="password" class="input-field" id="adminPassword" placeholder="Masukkan password">
                            </div>
                        </div>
                        <button class="btn-primary w-full" onclick="handleLogin()">Masuk</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SISWA VIEW -->
    <div class="view" id="siswaView">
        <main class="min-h-screen flex items-center justify-center p-4 relative z-10">
            <div class="w-full max-w-lg">
                <!-- Langkah 1-7 (Disingkat, Logika Sama) -->
                <div class="step active" id="step1"><div class="card p-8"><h1 class="text-2xl font-bold mb-4">Pilih Kelas</h1><select class="input-field" id="selectKelas"><option value="">Memuat...</option></select><button class="btn-primary w-full" onclick="nextStep(1)" id="btnStep1" disabled>Lanjutkan</button></div></div>
                <div class="step" id="step2"><div class="card p-8"><h1 class="text-2xl font-bold mb-4">Pilih Siswa <span id="selectedKelasLabel" class="text-orange-500"></span></h1><select class="input-field" id="selectSiswa"><option value="">-- Pilih --</option></select><div class="flex gap-3"><button class="btn-secondary flex-1" onclick="prevStep(1)">Kembali</button><button class="btn-primary flex-1" onclick="nextStep(2)" id="btnStep2" disabled>Lanjutkan</button></div></div></div>
                <div class="step" id="step3"><div class="card p-8"><h1 class="text-2xl font-bold mb-4">Konfirmasi Waktu</h1><input type="date" class="input-field mb-3" id="inputTanggal" readonly><input type="time" class="input-field" id="inputWaktu" readonly><div class="flex gap-3 mt-4"><button class="btn-secondary flex-1" onclick="prevStep(2)">Kembali</button><button class="btn-primary flex-1" onclick="nextStep(3)">Lanjutkan</button></div></div></div>
                <div class="step" id="step4"><div class="card p-8"><h1 class="text-2xl font-bold mb-4">Status Kehadiran</h1><div class="space-y-3 mb-6"><div class="status-option" onclick="selectStatus('hadir')" data-status="hadir"><div class="status-icon" style="background: rgba(16, 185, 129, 0.2)"><svg width="22" height="22" stroke="#10b981" viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5"/></svg></div><div><div class="font-semibold">Hadir</div></div></div><div class="status-option" onclick="selectStatus('izin')" data-status="izin"><div class="status-icon" style="background: rgba(245, 158, 11, 0.2)"><svg width="22" height="22" stroke="#f59e0b" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg></div><div><div class="font-semibold">Izin</div></div></div><div class="status-option" onclick="selectStatus('sakit')" data-status="sakit"><div class="status-icon" style="background: rgba(239, 68, 68, 0.2)"><svg width="22" height="22" stroke="#ef4444" viewBox="0 0 24 24" fill="none"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="3"/></svg></div><div><div class="font-semibold">Sakit</div></div></div><div class="status-option" onclick="selectStatus('alpha')" data-status="alpha"><div class="status-icon" style="background: rgba(107, 114, 128, 0.2)"><svg width="22" height="22" stroke="#6b7280" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="10"/><path d="m4.93 4.93 14.14 14.14"/></svg></div><div><div class="font-semibold">Alpha</div></div></div></div><div class="flex gap-3"><button class="btn-secondary flex-1" onclick="prevStep(3)">Kembali</button><button class="btn-primary flex-1" onclick="nextStep(4)" id="btnStep4" disabled>Lanjutkan</button></div></div></div>
                <div class="step" id="step5a"><div class="card p-8"><h1 class="text-2xl font-bold mb-4">Lokasi & Foto</h1><div class="mb-4"><label class="text-sm block mb-1 text-gray-400">Lokasi</label><div class="input-field" style="pointer-events:none"><span id="locationText">Mendapatkan...</span></div></div><div class="mb-4"><label class="text-sm block mb-1 text-gray-400">Foto</label><div style="background:#000; border-radius:12px; overflow:hidden; aspect-ratio:4/3; position:relative;"><video id="cameraVideo" autoplay playsinline style="display:none; width:100%; height:100%; object-fit:cover;"></video><img id="capturedPhoto" style="display:none; width:100%; height:100%; object-fit:cover;"><div id="cameraOverlay" style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; color:white;">Klik Buka Kamera</div></div><div class="flex gap-3 mt-3"><button class="btn-secondary flex-1" onclick="startCamera()" id="btnStartCamera">Buka Kamera</button><button class="btn-primary flex-1" onclick="capturePhoto()" id="btnCapture" disabled>Ambil Foto</button></div></div><div class="flex gap-3 mt-4"><button class="btn-secondary flex-1" onclick="prevStep(4)">Kembali</button><button class="btn-primary flex-1" onclick="nextStep(5)" id="btnStep5a" disabled>Selesai</button></div></div></div>
                <div class="step" id="step5b"><div class="card p-8"><h1 class="text-2xl font-bold mb-4">Keterangan</h1><textarea class="input-field" id="inputKeterangan" rows="3" placeholder="Tuliskan alasan..."></textarea><div class="flex gap-3 mt-4"><button class="btn-secondary flex-1" onclick="prevStep(4)">Kembali</button><button class="btn-primary flex-1" onclick="nextStep(5)">Selesai</button></div></div></div>
                <div class="step" id="step6"><div class="card p-8"><h1 class="text-2xl font-bold mb-4">Rekap Presensi</h1><div id="recapContainer" class="mb-6"></div><div class="flex gap-3"><button class="btn-secondary flex-1" onclick="editData()">Ubah Data</button><button class="btn-primary flex-1" onclick="submitPresensi()">Kirim Presensi</button></div></div></div>
                <div class="step" id="step7"><div class="card p-8 text-center"><div class="w-24 h-24 rounded-full mx-auto mb-6 flex items-center justify-center" style="background: linear-gradient(135deg, var(--success), #059669)"><svg width="48" height="48" stroke="white" viewBox="0 0 24 24" fill="none"><path d="M20 6 9 17l-5-5"/></svg></div><h1 class="text-2xl font-bold mb-2">Presensi Berhasil</h1><p style="color: var(--fg-secondary)" class="mb-6">ID: <span id="presensiId"></span></p><button class="btn-primary w-full" onclick="resetForm()">Presensi Baru</button><button class="btn-secondary w-full mt-3" onclick="logout()">Keluar</button></div></div>
            </div>
        </main>
    </div>

    <!-- ADMIN VIEW -->
    <div class="view" id="adminView">
        <button class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-gray-800 rounded" onclick="toggleSidebar()">â˜°</button>
        <aside class="sidebar" id="adminSidebar">
            <div class="p-5 border-b border-gray-700"><h2 class="font-bold">Admin Panel</h2></div>
            <nav class="py-4">
                <div class="sidebar-item active" onclick="showAdminSection('dashboard')">Dashboard</div>
                <div class="sidebar-item" onclick="showAdminSection('presensi')">Data Presensi</div>
                <div class="sidebar-item" onclick="showAdminSection('siswa')">Data Siswa</div>
                <div class="sidebar-item" onclick="showAdminSection('kelas')">Data Kelas</div>
            </nav>
            <div class="absolute bottom-0 left-0 right-0 p-4"><button class="btn-secondary w-full" onclick="logout()">Keluar</button></div>
        </aside>
        <main class="main-content">
            <h1 class="text-xl font-bold mb-6" id="adminSectionTitle">Dashboard</h1>
            <section id="sectionDashboard"><div class="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6"><div class="card p-5"><div class="text-2xl font-bold" id="statTotal">0</div><div class="text-sm text-gray-400">Total</div></div><div class="card p-5"><div class="text-2xl font-bold text-green-500" id="statHadir">0</div><div class="text-sm text-gray-400">Hadir</div></div><div class="card p-5"><div class="text-2xl font-bold text-yellow-500" id="statIzin">0</div><div class="text-sm text-gray-400">Izin</div></div><div class="card p-5"><div class="text-2xl font-bold text-red-500" id="statSakit">0</div><div class="text-sm text-gray-400">Sakit</div></div><div class="card p-5"><div class="text-2xl font-bold text-gray-500" id="statAlpha">0</div><div class="text-sm text-gray-400">Alpha</div></div></div><div class="card p-5"><h3 class="font-semibold mb-4">Aktivitas Terbaru</h3><table class="data-table"><thead><tr><th>Waktu</th><th>Nama</th><th>Status</th></tr></thead><tbody id="recentActivityBody"></tbody></table></div></section>
            <section id="sectionPresensi" class="hidden"><div class="card p-5"><div class="flex gap-3 mb-4"><input type="date" class="input-field" id="filterTanggal" oninput="loadPresensiData()"><select class="input-field" id="filterStatus" onchange="loadPresensiData()"><option value="">Semua</option><option value="hadir">Hadir</option><option value="izin">Izin</option><option value="sakit">Sakit</option><option value="alpha">Alpha</option></select></div><table class="data-table"><thead><tr><th>ID</th><th>Tanggal</th><th>Nama</th><th>Status</th><th>Aksi</th></tr></thead><tbody id="presensiTableBody"></tbody></table></div></section>
            <section id="sectionSiswa" class="hidden"><div class="card p-5"><div class="flex justify-between mb-4"><input type="text" class="input-field" style="width:200px" placeholder="Cari..." id="searchSiswa" oninput="loadSiswaData()"><div class="flex gap-2"><button class="btn-secondary" onclick="document.getElementById('importFile').click()">Import</button><input type="file" id="importFile" class="hidden" accept=".xlsx" onchange="handleImportFile(event)"><button class="btn-primary" onclick="openModal('addSiswaModal')">+ Tambah</button></div></div><table class="data-table"><thead><tr><th>ID</th><th>Nama</th><th>Kelas</th><th>Aksi</th></tr></thead><tbody id="siswaTableBody"></tbody></table></div></section>
            <section id="sectionKelas" class="hidden"><div class="card p-5"><div class="flex justify-between mb-4"><h3 class="font-semibold">Daftar Kelas</h3><button class="btn-primary" onclick="openModal('addKelasModal')">+ Tambah Kelas</button></div><table class="data-table"><thead><tr><th>Nama Kelas</th><th>Jumlah Siswa</th><th>Aksi</th></tr></thead><tbody id="kelasTableBody"></tbody></table></div></section>
        </main>
    </div>

    <!-- MODALS -->
    <div class="modal-overlay" id="addSiswaModal"><div class="modal-content"><div class="p-5 border-b border-gray-700"><h3 class="font-semibold">Tambah Siswa</h3></div><div class="p-5 space-y-4"><input type="text" id="addSiswaId" class="input-field" placeholder="NIS"><input type="text" id="addSiswaNama" class="input-field" placeholder="Nama"><select id="addSiswaKelas" class="input-field"></select></div><div class="p-5 flex gap-3"><button class="btn-secondary flex-1" onclick="closeModal('addSiswaModal')">Batal</button><button class="btn-primary flex-1" onclick="saveNewSiswa()">Simpan</button></div></div></div>
    <div class="modal-overlay" id="addKelasModal"><div class="modal-content"><div class="p-5 border-b border-gray-700"><h3 class="font-semibold">Tambah Kelas</h3></div><div class="p-5"><input type="text" id="addKelasNama" class="input-field" placeholder="Nama Kelas"></div><div class="p-5 flex gap-3"><button class="btn-secondary flex-1" onclick="closeModal('addKelasModal')">Batal</button><button class="btn-primary flex-1" onclick="saveNewKelas()">Simpan</button></div></div></div>

    <script>
        // ==========================================
        // CONFIG & API
        // ==========================================
        // GANTI DENGAN URL BARU DARI LANGKAH 1
        const API_URL = 'https://script.google.com/macros/s/AKfycbzCAoXHIB9HpELx77vs9h3jWSz8jE8AR0OhtGCsqBX_cq3M4WFtRzfQsUcEL-ugIL7E/exec'; 

        let databaseSiswa = {}; 
        let presensiData = [];  
        let appSettings = JSON.parse(localStorage.getItem('appSettings')) || { theme: 'dark' };
        let formData = {}, currentStep=1, cameraStream=null, isAnimating=false;

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('loginMode').onchange = (e) => document.getElementById('adminLoginFields').classList.toggle('hidden', e.target.value === 'siswa');
        });

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<span style="color:${type === 'error' ? 'var(--danger)' : 'var(--success)'}">${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ==========================================
        // API CALL (PERBAIKAN CORS)
        // ==========================================
        async function api(action, params = {}, method = 'GET') {
            // Kita selalu gunakan POST dengan body JSON untuk menghindari CORS di Google Script
            // Google Script menerima POST lebih "ramah" daripada GET dari domain berbeda
            
            let payload = { action: action, ...params };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Ini triknya
                    headers: { 'Content-Type': 'text/plain' }, // WAJIB text/plain, bukan application/json
                    body: JSON.stringify(payload)
                });

                // Karena mode 'no-cors', kita tidak bisa membaca response JSON langsung.
                // Kita asumsikan sukses jika tidak error. Untuk mendapatkan data balikan, 
                // kita perlu trik JSONP atau accept biasa jika GET.
                
                // KARENA 'no-cors' menyembunyikan response, kita gunakan cara LAMA (JSONP) untuk GET.
                // Jika method POST, kita anggap sukses simpan.
                if(method === 'POST') return { status: 'success' }; 

            } catch (err) {
                console.error("POST Error:", err);
                throw err;
            }
        }

        // FUNGSI KHUSUS UNTUK AMBIL DATA (GET) DENGAN JSONP
        function apiGet(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = 'cb_' + Math.floor(Math.random() * 100000);
                const script = document.createElement('script');
                
                const queryParams = new URLSearchParams({ action: action, ...params, callback: callbackName });
                script.src = API_URL + '?' + queryParams.toString();

                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    if (data.status === 'success') resolve(data);
                    else reject(new Error(data.message || 'Gagal'));
                };

                script.onerror = () => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    reject(new Error('Koneksi gagal'));
                };

                document.body.appendChild(script);
            });
        }

        // ==========================================
        // LOGIC IMPLEMENTATIONS
        // ==========================================

        function handleLogin() {
            const mode = document.getElementById('loginMode').value;
            if(mode === 'admin') {
                const user = document.getElementById('adminUsername').value;
                const pass = document.getElementById('adminPassword').value;
                if(user === 'admin' && pass === 'admin123') switchView('adminView');
                else showToast('Login salah', 'error');
            } else {
                switchView('siswaView');
            }
        }
        function logout() { switchView('loginView'); }
        
        function switchView(targetId) {
            const current = document.querySelector('.view.active');
            const next = document.getElementById(targetId);
            current.classList.remove('active');
            next.classList.add('active');
            if(targetId === 'adminView') { initAdmin(); }
            else if(targetId === 'siswaView') { initSiswa(); }
        }

        // SISWA LOGIC
        async function initSiswa() { 
            resetForm(); 
            await loadKelasDataForSiswa(); 
            updateDateTime(); 
        }
        
        function resetForm() {
            formData = {};
            currentStep = 1;
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step1').classList.add('active');
        }

        async function loadKelasDataForSiswa() {
            const select = document.getElementById('selectKelas');
            select.innerHTML = '<option value="">Memuat...</option>';
            try {
                const result = await apiGet('getKelas'); // PAKAI apiGet
                databaseSiswa = result.data;
                select.innerHTML = '<option value="">-- Pilih Kelas --</option>';
                Object.keys(databaseSiswa).sort().forEach(k => select.add(new Option(k, k)));
                select.onchange = function() { 
                    formData.kelas = this.value; 
                    loadSiswaDataForSiswa(this.value); 
                    document.getElementById('btnStep1').disabled = !this.value; 
                };
            } catch (err) {
                select.innerHTML = '<option value="">Gagal memuat</option>';
                showToast('Gagal mengambil data kelas', 'error');
            }
        }

        async function loadSiswaDataForSiswa(kelas) {
            const select = document.getElementById('selectSiswa');
            select.innerHTML = '<option value="">Memuat...</option>';
            try {
                const result = await apiGet('getSiswa', { kelas: kelas }); // PAKAI apiGet
                select.innerHTML = '<option value="">-- Pilih Siswa --</option>';
                result.data.sort((a,b) => a.nama.localeCompare(b.nama)).forEach(s => select.add(new Option(s.nama, s.id)));
                select.onchange = function() { 
                    formData.siswa = result.data.find(s => s.id === this.value); 
                    document.getElementById('btnStep2').disabled = !this.value; 
                };
            } catch(err) {
                select.innerHTML = '<option value="">Gagal</option>';
            }
        }
        
        function updateDateTime() { 
            let now = new Date(); 
            document.getElementById('inputTanggal').value = now.toISOString().split('T')[0]; 
            document.getElementById('inputWaktu').value = now.toTimeString().slice(0,5); 
        }

        function selectStatus(status) { 
            formData.status = status; 
            document.querySelectorAll('.status-option').forEach(el => el.classList.remove('selected')); 
            document.querySelector(`[data-status="${status}"]`).classList.add('selected'); 
            document.getElementById('btnStep4').disabled = false; 
        }

        async function startCamera() { 
            try { 
                if(cameraStream) cameraStream.getTracks().forEach(t => t.stop()); 
                cameraStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}}); 
                let video = document.getElementById('cameraVideo'); 
                video.srcObject = cameraStream; 
                video.style.display = 'block'; 
                document.getElementById('cameraOverlay').style.display = 'none'; 
                document.getElementById('capturedPhoto').style.display = 'none'; 
                document.getElementById('btnCapture').disabled = false; 
                document.getElementById('btnStep5a').disabled = true; 
            } catch(e) { showToast('Gagal buka kamera', 'error'); } 
        }

        function capturePhoto() { 
            let video = document.getElementById('cameraVideo'); 
            let photo = document.getElementById('capturedPhoto'); 
            let canvas = document.createElement('canvas'); 
            canvas.width = video.videoWidth; 
            canvas.height = video.videoHeight; 
            canvas.getContext('2d').drawImage(video, 0, 0); 
            photo.src = canvas.toDataURL('image/jpeg'); 
            photo.style.display = 'block'; 
            video.style.display = 'none'; 
            formData.foto = photo.src; 
            if(cameraStream) cameraStream.getTracks().forEach(t => t.stop()); 
            document.getElementById('btnStep5a').disabled = false;
        }
        
        // STEP NAVIGATION
        function nextStep(from) { 
            if(isAnimating) return; isAnimating = true; 
            const steps = ['step1','step2','step3','step4','step5a','step5b','step6','step7']; 
            let nextId; 
            if(from===4) nextId = formData.status === 'hadir' ? 'step5a' : 'step5b'; 
            else if(from===5) { showRecap(); nextId = 'step6'; } 
            else nextId = steps[from]; 
            document.getElementById(steps[from-1]).classList.remove('active'); 
            document.getElementById(nextId).classList.add('active'); 
            if(from===2) document.getElementById('selectedKelasLabel').textContent = formData.kelas; 
            currentStep = from+1; 
            isAnimating = false; 
        }
        
        function prevStep(to) { 
            const steps = ['step1','step2','step3','step4','step5a','step5b','step6','step7']; 
            document.getElementById(steps[currentStep-1]).classList.remove('active'); 
            document.getElementById('step'+to).classList.add('active'); 
            currentStep=to; 
        }
        
        function showRecap() { 
            let statusColors = {hadir:'var(--success)', izin:'var(--warning)', sakit:'var(--danger)', alpha:'var(--alpha)'}; 
            let keterangan = formData.status === 'hadir' ? 'Lokasi OK' : document.getElementById('inputKeterangan').value; 
            document.getElementById('recapContainer').innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between py-2 border-b border-gray-700"><span class="text-gray-400">Nama</span><span class="font-semibold">${formData.siswa?.nama}</span></div>
                    <div class="flex justify-between py-2 border-b border-gray-700"><span class="text-gray-400">Kelas</span><span class="font-semibold">${formData.kelas}</span></div>
                    <div class="flex justify-between py-2 border-b border-gray-700"><span class="text-gray-400">Status</span><span class="font-semibold" style="color:${statusColors[formData.status]}">${formData.status.toUpperCase()}</span></div>
                </div>`; 
        }
        
        async function submitPresensi() {
            const btn = document.getElementById('btnSubmitPresensi');
            btn.disabled = true;
            btn.innerHTML = 'Mengirim...';

            const id = 'PRSN-'+Date.now().toString(36).toUpperCase();
            const keterangan = formData.status === 'hadir' ? 'Hadir' : document.getElementById('inputKeterangan').value;
            const dataToSend = { id: id, tanggal: document.getElementById('inputTanggal').value, waktu: document.getElementById('inputWaktu').value, nama: formData.siswa.nama, kelas: formData.kelas, status: formData.status, keterangan: keterangan };

            try {
                await api('submitPresensi', { data: dataToSend }, 'POST'); // PAKAI api (POST)
                document.getElementById('presensiId').textContent = id;
                nextStep(6);
                showToast('Presensi berhasil');
            } catch (err) {
                showToast('Gagal kirim', 'error');
                btn.disabled = false;
                btn.textContent = 'Kirim Presensi';
            }
        }

        // ADMIN LOGIC
        async function initAdmin() { 
            await loadDashboard(); 
            document.getElementById('filterTanggal').value = new Date().toISOString().split('T')[0];
        }
        
        function toggleSidebar() { document.getElementById('adminSidebar').classList.toggle('open'); }
        
        async function showAdminSection(sec) { 
            document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active')); 
            event.currentTarget.classList.add('active'); 
            document.querySelectorAll('section').forEach(s=>s.classList.add('hidden')); 
            document.getElementById('section'+sec.charAt(0).toUpperCase()+sec.slice(1)).classList.remove('hidden');
            if(window.innerWidth <= 1024) document.getElementById('adminSidebar').classList.remove('open');
            if(sec==='dashboard') loadDashboard(); 
            if(sec==='presensi') loadPresensiData(); 
            if(sec==='siswa') loadSiswaData(); 
            if(sec==='kelas') loadKelasData(); 
        }

        async function loadDashboard() {
            let today = new Date().toISOString().split('T')[0];
            try {
                const result = await apiGet('getPresensi', { tanggal: today }); // PAKAI apiGet
                const data = result.data || [];
                document.getElementById('statTotal').textContent = data.length;
                document.getElementById('statHadir').textContent = data.filter(p=>p.status==='hadir').length;
                document.getElementById('statIzin').textContent = data.filter(p=>p.status==='izin').length;
                document.getElementById('statSakit').textContent = data.filter(p=>p.status==='sakit').length;
                document.getElementById('statAlpha').textContent = data.filter(p=>p.status==='alpha').length;
                document.getElementById('recentActivityBody').innerHTML = data.slice(0, 5).map(p => `<tr><td>${p.waktu}</td><td>${p.siswaNama}</td><td><span class="badge badge-success">${p.status}</span></td></tr>`).join('') || '<tr><td colspan="3" class="text-center">-</td></tr>';
            } catch(err) { console.error(err); }
        }
        
        async function loadPresensiData() {
            let tgl = document.getElementById('filterTanggal').value;
            try {
                const result = await apiGet('getPresensi', { tanggal: tgl }); // PAKAI apiGet
                let data = result.data || [];
                document.getElementById('presensiTableBody').innerHTML = data.map(p => `<tr><td>${p.id}</td><td>${p.tanggal}</td><td>${p.siswaNama}</td><td>${p.status}</td><td><button class="btn-danger btn-sm" onclick="deletePresensi('${p.id}')">Hapus</button></td></tr>`).join('') || '<tr><td colspan="5" class="text-center">-</td></tr>';
            } catch(err) { showToast('Gagal memuat', 'error'); }
        }
        
        async function deletePresensi(id) { 
            if(!confirm("Hapus?")) return;
            try {
                await api('deletePresensi', { id: id }, 'POST'); // PAKAI api (POST)
                showToast('Terhapus');
                loadPresensiData(); loadDashboard(); 
            } catch(err) { showToast('Gagal', 'error'); }
        }

        async function loadSiswaData() {
            try {
                const kelasResult = await apiGet('getKelas');
                let allSiswa = [];
                for(const k of Object.keys(kelasResult.data)) {
                    const siswaResult = await apiGet('getSiswa', { kelas: k });
                    allSiswa = allSiswa.concat(siswaResult.data);
                }
                document.getElementById('siswaTableBody').innerHTML = allSiswa.map(s => `<tr><td>${s.id}</td><td>${s.nama}</td><td>${s.kelas}</td><td><button class="btn-danger btn-sm" onclick="deleteSiswa('${s.id}')">Hapus</button></td></tr>`).join('') || '<tr><td colspan="4" class="text-center">-</td></tr>';
            } catch(err) { console.error(err); }
        }
        
        async function saveNewSiswa() {
            let id = document.getElementById('addSiswaId').value.trim();
            let nama = document.getElementById('addSiswaNama').value.trim();
            let kelas = document.getElementById('addSiswaKelas').value;
            if(!id || !nama || !kelas) { showToast('Lengkapi data', 'error'); return; }
            try {
                await api('addSiswa', { id: id, nama: nama, kelas: kelas }, 'POST');
                showToast('Siswa ditambahkan');
                closeModal('addSiswaModal'); loadSiswaData(); 
            } catch(err) { showToast('Gagal', 'error'); }
        }
        
        async function deleteSiswa(id) {
            if(!confirm("Hapus?")) return;
            try {
                await api('deleteSiswa', { id: id }, 'POST');
                showToast('Terhapus');
                loadSiswaData();
            } catch(err) { showToast('Gagal', 'error'); }
        }

        async function loadKelasData() {
            try {
                const result = await apiGet('getKelas'); // PAKAI apiGet
                const data = result.data;
                // Populate dropdown siswa
                let el = document.getElementById('addSiswaKelas');
                el.innerHTML = '<option value="">Pilih Kelas</option>';
                Object.keys(data).sort().forEach(k => el.add(new Option(k, k)));
                // Populate table
                document.getElementById('kelasTableBody').innerHTML = Object.keys(data).sort().map(k => `<tr><td>${k}</td><td>${data[k].length || 0}</td><td><button class="btn-danger btn-sm" onclick="deleteKelas('${k}')">Hapus</button></td></tr>`).join('') || '<tr><td colspan="3" class="text-center">-</td></tr>';
            } catch(err) { console.error(err); }
        }
        
        async function saveNewKelas() {
            let nama = document.getElementById('addKelasNama').value.trim();
            if(!nama) { showToast('Nama wajib', 'error'); return; }
            try {
                await api('addKelas', { nama: nama }, 'POST');
                showToast('Kelas ditambahkan');
                closeModal('addKelasModal'); loadKelasData(); 
            } catch(err) { showToast('Gagal', 'error'); }
        }
        
        async function deleteKelas(k) {
            if(!confirm("Hapus?")) return;
            try {
                await api('deleteKelas', { nama: k }, 'POST');
                showToast('Terhapus');
                loadKelasData();
            } catch(err) { showToast('Gagal', 'error'); }
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    </script>
</body>
</html>
